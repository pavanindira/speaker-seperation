{% extends "base.html" %}

{% block title %}Upload Audio | Speaker Separation{% endblock %}

{% block content %}
  <section class="hero">
    <h1>Speaker Separation</h1>
    <p class="subtle">
      Upload an audio file with multiple speakers and get individual voice tracks.
    </p>
  </section>

  <!-- Upload Section -->
  <section class="card">
    <h2>Upload Audio</h2>
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon"> folder</div>
      <div class="upload-text">Drop your audio file here</div>
      <div class="upload-hint">or click to browse - MP3, WAV, M4A, FLAC, OGG - Max 100MB</div>
      <form id="uploadForm" action="/ui/upload" method="post" enctype="multipart/form-data" style="display: none;">
        <input type="file" id="fileInput" name="file" accept=".mp3,.wav,.m4a,.flac,.ogg,audio/*" required />
      </form>
    </div>
  </section>

  <!-- Settings -->
  <section class="card">
    <h2>Settings</h2>
    <div class="settings">
      <div class="setting-row">
        <span>Number of Speakers</span>
        <input type="number" id="numSpeakers" value="2" min="2" max="10" />
      </div>
      <div class="setting-row">
        <span>Separation Method</span>
        <select id="method">
          <option value="gmm" selected>GMM (Recommended)</option>
          <option value="kmeans">K-Means (Faster)</option>
          <option value="spectral">Spectral (Advanced)</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Tips -->
  <section class="card">
    <h2>Tips for Best Results</h2>
    <ul class="list">
      <li>Use high-quality recordings with minimal background noise</li>
      <li>Works best with 30 seconds to 10 minutes of audio</li>
      <li>If unsure about speaker count, start with 2</li>
      <li>Keep files under 100MB for faster processing</li>
    </ul>
  </section>

  <!-- Recent Jobs -->
  {% if recent_jobs and recent_jobs|length > 0 %}
  <section class="card">
    <h2>Recent Jobs</h2>
    <div class="jobList">
      {% for j in recent_jobs %}
        <a class="jobItem" href="/ui/jobs/{{ j.job_id }}">
          <div class="jobMain">
            <div class="jobTitle">{{ j.filename }}</div>
            <div class="jobSubtle mono">{{ j.job_id }}</div>
          </div>
          <div class="jobMeta">
            <span class="pill {{ j.status }}">{{ j.status }}</span>
            <span class="jobTime mono">{{ j.created_at }}</span>
          </div>
        </a>
      {% endfor %}
    </div>
    <p class="hint">Jobs are stored in memory and reset when the server restarts.</p>
  </section>
  {% else %}
  <section class="card">
    <h2>Recent Jobs</h2>
    <p class="subtle">No jobs yet. Upload an audio file to get started.</p>
  </section>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  // Upload area drag & drop
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const uploadForm = document.getElementById('uploadForm');

  uploadArea.addEventListener('click', () => {
    fileInput.click();
  });

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragging');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragging');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragging');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      submitForm();
    }
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      submitForm();
    }
  });

  function submitForm() {
    // Store settings in sessionStorage for the job page
    sessionStorage.setItem('numSpeakers', document.getElementById('numSpeakers').value);
    sessionStorage.setItem('method', document.getElementById('method').value);
    
    uploadForm.submit();
  }
</script>
{% endblock %}
