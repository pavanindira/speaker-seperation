{% extends "base.html" %}

{% block title %}Upload Audio | Speaker Separation{% endblock %}

{% block content %}
  <!-- Error Display Container -->
  <div class="error-container hidden" id="errorContainer">
    <!-- Error content inserted by JavaScript -->
  </div>

  <!-- Progress Indicator -->
  <div class="progress-indicator hidden" id="progressIndicator">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <div class="progress-text" id="progressText">Uploading...</div>
  </div>

  <section class="hero">
    <h1>Speaker Separation</h1>
    <p class="subtle">
      Upload an audio file with multiple speakers and get individual voice tracks.
    </p>
  </section>

  <!-- Upload Section -->
  <section class="card">
    <h2>Upload Audio</h2>
    <form id="uploadForm" action="/ui/upload" method="post" enctype="multipart/form-data" class="form">
      <label class="label" for="file">Audio file</label>
      <input class="input" id="file" name="file" type="file" accept=".mp3,.wav,.flac,.ogg,.m4a,audio/*" required />

      <div class="actions">
        <button class="button" type="submit">Upload & continue</button>
        <a class="button secondary" href="/docs" target="_blank" rel="noopener">Open API docs</a>
      </div>

      <p class="hint">Supported: mp3, wav, flac, ogg, m4a. Max size is enforced server-side.</p>
    </form>
  </section>

  <!-- Settings -->
  <section class="card">
    <h2>Settings</h2>
    <div class="settings">
      <div class="setting-row">
        <span>Number of Speakers</span>
        <input type="number" id="numSpeakers" value="2" min="2" max="10" />
      </div>
      <div class="setting-row">
        <span>Separation Method</span>
        <select id="method">
          <option value="gmm" selected>GMM (Recommended)</option>
          <option value="kmeans">K-Means (Faster)</option>
          <option value="spectral">Spectral (Advanced)</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Tips -->
  <section class="card">
    <h2>Tips for Best Results</h2>
    <ul class="list">
      <li>Use high-quality recordings with minimal background noise</li>
      <li>Works best with 30 seconds to 10 minutes of audio</li>
      <li>If unsure about speaker count, start with 2</li>
      <li>Keep files under 100MB for faster processing</li>
    </ul>
  </section>

  <!-- Recent Jobs -->
  {% if recent_jobs and recent_jobs|length > 0 %}
  <section class="card">
    <h2>Recent Jobs</h2>
    <div class="jobList">
      {% for j in recent_jobs %}
        <a class="jobItem" href="/ui/jobs/{{ j.job_id }}">
          <div class="jobMain">
            <div class="jobTitle">{{ j.filename }}</div>
            <div class="jobSubtle mono">{{ j.job_id }}</div>
          </div>
          <div class="jobMeta">
            <span class="pill {{ j.status }}">{{ j.status }}</span>
            <span class="jobTime mono">{{ j.created_at }}</span>
          </div>
        </a>
      {% endfor %}
    </div>
    <p class="hint">Jobs are stored in memory and reset when the server restarts.</p>
  </section>
  {% else %}
  <section class="card">
    <h2>Recent Jobs</h2>
    <p class="subtle">No jobs yet. Upload an audio file to get started.</p>
  </section>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  (function() {
    var uploadForm = document.getElementById('uploadForm');
    
    // Form submit - store settings
    uploadForm.addEventListener('submit', function(e) {
      // Store settings in sessionStorage for the job page
      var numSpeakers = document.getElementById('numSpeakers').value;
      var method = document.getElementById('method').value;
      sessionStorage.setItem('numSpeakers', numSpeakers);
      sessionStorage.setItem('method', method);
    });
  })();
</script>
{% endblock %}
