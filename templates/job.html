{% extends "base.html" %}

{% block title %}Job {{ job_id }} | Speaker Separation{% endblock %}

{% block content %}
  <!-- Progress Section -->
  <section class="hero narrow centerLayout">
    <h1>Processing</h1>
    <p class="subtle">
      <span class="mono">{{ job_id }}</span>
    </p>
    
    <div class="stage-indicator">
      <div class="stage-icon" id="stageIcon"> </div>
      <div>
        <div class="stage-text" id="stageText">Loading...</div>
      </div>
    </div>
    
    <div class="progressWrap">
      <div class="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progressFill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progressText" id="progressText">Loading...</div>
    </div>
  </section>

  <!-- Stepper -->
  <section class="card narrow centerLayout">
    <div class="stepper stepperCompact" aria-label="Workflow steps">
      <div class="step" id="step1">
        <div class="dot">1</div>
        <div class="meta">
          <div class="name">Diagnose</div>
          <div class="desc">Analyze audio</div>
        </div>
      </div>
      <div class="step" id="step2">
        <div class="dot">2</div>
        <div class="meta">
          <div class="name">Separate</div>
          <div class="desc">Split speakers</div>
        </div>
      </div>
      <div class="step" id="step3">
        <div class="dot">3</div>
        <div class="meta">
          <div class="name">Clean</div>
          <div class="desc">Optional</div>
        </div>
      </div>
      <div class="step" id="step4">
        <div class="dot">4</div>
        <div class="meta">
          <div class="name">Download</div>
          <div class="desc">Get results</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content Card -->
  <section class="card narrow centerLayout">
    <h2 id="wizardTitle">Loading...</h2>
    <p class="subtle" id="wizardSubtitle">Please wait.</p>

    <div id="alert" class="alert hidden"></div>

    <!-- Audio Preview -->
    <div class="audioPreview hidden" id="audioPreviewWrap">
      <div class="label">Original audio</div>
      <audio id="audioPreview" controls preload="metadata"></audio>
    </div>

    <!-- Diagnosis Card -->
    <div id="diagnosisCard" class="summaryCard hidden">
      <div class="summaryGrid">
        <div class="summaryItem">
          <div class="label">Estimated speakers</div>
          <div class="summaryValue" id="diagSpeakers">-</div>
        </div>
        <div class="summaryItem">
          <div class="label">Quality</div>
          <div class="summaryValue" id="diagQuality">-</div>
        </div>
        <div class="summaryItem">
          <div class="label">Duration</div>
          <div class="summaryValue" id="diagDuration">-</div>
        </div>
        <div class="summaryItem">
          <div class="label">Sample rate</div>
          <div class="summaryValue" id="diagSr">-</div>
        </div>
      </div>
      <div class="summaryLists">
        <div>
          <div class="label">Issues</div>
          <ul class="list" id="diagIssues"></ul>
        </div>
        <div>
          <div class="label">Recommendations</div>
          <ul class="list" id="diagRecs"></ul>
        </div>
      </div>
    </div>

    <!-- Step 1: Diagnose -->
    <div id="sectionDiagnose" class="wizardSection hidden">
      <div class="actions">
        <button class="button" id="btnDiagnose">Analyze audio</button>
      </div>
    </div>

    <!-- Step 2: Separate -->
    <div id="sectionSeparate" class="wizardSection hidden">
      <div class="summaryLine" id="separationSummary"></div>
      <div class="actions">
        <button class="button" id="btnProceed">Start separation</button>
      </div>

      <details class="details leftLayout">
        <summary class="detailsSummary">Advanced settings</summary>
        <div class="detailsBody">
          <div class="row">
            <div>
              <label class="label" for="numSpeakers">Speakers</label>
              <input class="input small" id="numSpeakers" type="number" min="1" max="10" value="2" />
              <div class="hint" id="speakerHint"></div>
            </div>

            <div>
              <label class="label" for="method">Method</label>
              <select class="input small" id="method">
                <option value="gmm" selected>gmm (recommended)</option>
                <option value="kmeans">kmeans</option>
                <option value="spectral">spectral</option>
              </select>
              <div class="hint">If unsure, keep <span class="mono">gmm</span>.</div>
            </div>
          </div>
        </div>
      </details>
    </div>

    <!-- Processing -->
    <div id="sectionProcessing" class="wizardSection hidden">
      <p class="subtle">Working in the background. This page updates automatically.</p>
    </div>

    <!-- Step 3: Clean -->
    <div id="sectionClean" class="wizardSection hidden">
      <div class="actions">
        <button class="button" id="btnClean">Clean audio (optional)</button>
        <button class="button secondary" id="btnSkipClean" type="button">Skip</button>
      </div>
    </div>

    <!-- Step 4: Download -->
    <div id="sectionDownload" class="wizardSection hidden">
      <div class="actions">
        <a class="button secondary" href="/ui">Upload another</a>
      </div>
    </div>

    <!-- Failed -->
    <div id="sectionFailed" class="wizardSection hidden">
      <div class="actions">
        <a class="button secondary" href="/ui">Upload another</a>
      </div>
    </div>

    <!-- Error Container -->
    <div class="error-container hidden" id="errorContainer">
      <!-- Error content inserted by JavaScript -->
    </div>

    <details class="details subtle leftLayout" style="margin-top: 12px;">
      <summary class="detailsSummary">Debug info</summary>
      <div class="detailsBody">
        <pre class="pre" id="jobJson">Loading...</pre>
      </div>
    </details>
  </section>

  <!-- Results Section -->
  <section class="card narrow">
    <h2>Results</h2>
    <div id="downloads" class="downloads subtle">No files yet.</div>
  </section>

  <!-- Full-page loader overlay -->
  <div id="loaderOverlay" class="loaderOverlay hidden" aria-live="polite" aria-busy="true">
    <div class="loaderCard">
      <div class="spinner" aria-hidden="true"></div>
      <div>
        <div class="loaderTitle" id="loaderTitle">Working...</div>
        <div class="loaderSubtitle" id="loaderSubtitle">Please wait.</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const jobId = "{{ job_id }}";
    const API_BASE = window.location.origin;
    
    // Restore settings from sessionStorage if available
    document.addEventListener('DOMContentLoaded', () => {
      const savedSpeakers = sessionStorage.getItem('numSpeakers');
      const savedMethod = sessionStorage.getItem('method');
      if (savedSpeakers) {
        document.getElementById('numSpeakers').value = savedSpeakers;
      }
      if (savedMethod) {
        document.getElementById('method').value = savedMethod;
      }
    });
  </script>
  <script src="/static/ui.js?v=8"></script>
{% endblock %}
